<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ¨æ€Todoåº”ç”¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap');
        </style>
    <style>
        body{
            font-size: 14px;
            font-family: "Lato", sans-serif;
            font-weight: 400;
            font-style: normal;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    <style>
        .outpostCard{
            font-family: "Noto Sans", sans-serif;
  font-optical-sizing: auto;
  font-weight: 400;
  font-style: normal;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen transition-colors duration-300">
    <div class="container mx-auto px-4 py-8">
        <!-- å¤´éƒ¨ -->
        <header class="mb-8 fade-in">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white">åŠ¨æ€Todoæ¸…å•</h1>
                <div class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300">
                    <span id="currentPath"></span>
                    <button id="settingsBtn" class="ml-2 px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        é…ç½®
                    </button>
                </div>
            </div>
            
            <!-- æœç´¢å’Œè¿‡æ»¤ -->
            <div class="flex flex-wrap gap-4 mt-4">
                <input type="text" id="searchInput" placeholder="æœç´¢todo..." 
                       class="flex-1 min-w-[200px] px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                
                <select id="tagFilter" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    <option value="">æ‰€æœ‰æ ‡ç­¾</option>
                </select>
                
                <select id="statusFilter" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    <option value="active">æ´»åŠ¨çŠ¶æ€</option>
                    <option value="archived">å·²å½’æ¡£</option>
                    <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                </select>
                
                <button id="addTodoBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors">
                    æ–°å»ºTodo
                </button>
            </div>
        </header>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div id="stats" class="mb-6 grid grid-cols-2 md:grid-cols-4 gap-4 fade-in">
            <!-- ç»Ÿè®¡å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- Todoåˆ—è¡¨å®¹å™¨ -->
        <div id="todoList" class="flex flex-col gap-4">
            <!-- Todoå¡ç‰‡å°†åŠ¨æ€æ¸²æŸ“åœ¨è¿™é‡Œ -->
        </div>

        <!-- ç©ºçŠ¶æ€ -->
        <div id="emptyState" class="hidden text-center py-12 fade-in">
            <div class="text-gray-400 dark:text-gray-500 mb-4">
                <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
            </div>
            <h3 class="text-lg font-medium text-gray-600 dark:text-gray-400 mb-2">æš‚æ— å¾…åŠäº‹é¡¹</h3>
            <p class="text-gray-500 dark:text-gray-500 mb-4">ç‚¹å‡»"æ–°å»ºTodo"å¼€å§‹æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ªä»»åŠ¡</p>
            <button id="emptyAddBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors">
                åˆ›å»ºç¬¬ä¸€ä¸ªTodo
            </button>
        </div>
    </div>

    <!-- ç¼–è¾‘/æ–°å»ºTodoçš„å¯¹è¯æ¡† -->
    <div id="todoDialog" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4 fade-in">
            <h2 id="dialogTitle" class="text-xl font-bold mb-4 text-gray-800 dark:text-white">æ–°å»ºTodo</h2>
            <form id="todoForm" class="space-y-4">
                <input type="hidden" id="todoId">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æ ‡é¢˜ *</label>
                    <input type="text" id="title" required
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æ ‡ç­¾ (é€—å·åˆ†éš”)</label>
                    <input type="text" id="tags"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                           placeholder="å·¥ä½œ, ç´§æ€¥, ä¸ªäºº">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">å¼€å§‹æ—¥æœŸ *</label>
                        <input type="date" id="startDate" required
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ç»“æŸæ—¥æœŸ *</label>
                        <input type="date" id="endDate" required
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ä¼˜å…ˆçº§</label>
                    <select id="priority" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="low">ä½</option>
                        <option value="medium">ä¸­</option>
                        <option value="high">é«˜</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">è´Ÿè´£äºº *</label>
                    <input type="text" id="assignee" required
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="cancelBtn" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors">
                        å–æ¶ˆ
                    </button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md transition-colors">
                        ä¿å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- é…ç½®å¯¹è¯æ¡† -->
    <div id="settingsDialog" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-2xl mx-4 fade-in">
            <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">åº”ç”¨é…ç½®</h2>
            <div class="space-y-6 max-h-96 overflow-y-auto">
                <!-- è·¯å¾„é…ç½® -->
                <div>
                    <h3 class="text-lg font-medium mb-3 text-gray-800 dark:text-white">æ•°æ®è·¯å¾„é…ç½®</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Todoæ•°æ®æ ¹è·¯å¾„</label>
                            <input type="text" id="appRootPath" 
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Firebaseæ•°æ®åº“ä¸­çš„è·¯å¾„ï¼Œä¾‹å¦‚: /todos æˆ– /users/123/todos</p>
                        </div>
                    </div>
                </div>

                <!-- åŠŸèƒ½å¼€å…³ -->
                <div>
                    <h3 class="text-lg font-medium mb-3 text-gray-800 dark:text-white">åŠŸèƒ½å¼€å…³</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="flex items-center space-x-3">
                            <input type="checkbox" id="featureSearch" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">æœç´¢åŠŸèƒ½</span>
                        </label>
                        <label class="flex items-center space-x-3">
                            <input type="checkbox" id="featureFiltering" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">æ ‡ç­¾è¿‡æ»¤</span>
                        </label>
                        <label class="flex items-center space-x-3">
                            <input type="checkbox" id="featureArchiving" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">å½’æ¡£åŠŸèƒ½</span>
                        </label>
                        <label class="flex items-center space-x-3">
                            <input type="checkbox" id="featureDueDateWarning" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">åˆ°æœŸæé†’</span>
                        </label>
                    </div>
                </div>

                <!-- UIé…ç½® -->
                <div>
                    <h3 class="text-lg font-medium mb-3 text-gray-800 dark:text-white">ç•Œé¢è®¾ç½®</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ä¸»é¢˜</label>
                            <select id="uiTheme" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="light">æµ…è‰²</option>
                                <option value="dark">æ·±è‰²</option>
                                <option value="auto">è‡ªåŠ¨</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">æ¯è¡Œå¡ç‰‡æ•°é‡</label>
                            <select id="uiCardsPerRow" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="1">1ä¸ª</option>
                                <option value="2">2ä¸ª</option>
                                <option value="3">3ä¸ª</option>
                                <option value="4">4ä¸ª</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between items-center pt-6 mt-6 border-t border-gray-200 dark:border-gray-600">
                <button type="button" id="resetSettingsBtn" class="px-4 py-2 text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 transition-colors">
                    é‡ç½®ä¸ºé»˜è®¤
                </button>
                <div class="flex gap-3">
                    <button type="button" id="settingsCancelBtn" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition-colors">
                        å–æ¶ˆ
                    </button>
                    <button type="button" id="saveSettingsBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md transition-colors">
                        ä¿å­˜é…ç½®
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>

// Firebaseé…ç½® - è¯·æ›¿æ¢ä¸ºä½ çš„å®é™…é…ç½®
const firebaseConfig = {
    apiKey: "AIzaSyA6MZ_p5lVuy8TMAqiuV6IRx9fggV44lQs",
    authDomain: "outpost-8d74e.firebaseapp.com",
    databaseURL: "https://outpost-8d74e.asia-southeast1.firebasedatabase.app/",
    projectId: "outpost-8d74e",
    storageBucket: "outpost-8d74e.firebasestorage.app",
    messagingSenderId: "724993324937",
    appId: "1:724993324937:web:ce6c7e6b06489331c79358",
    measurementId: "G-QPHWRTH6BH"
};

// åˆå§‹åŒ–Firebase
try {
    firebase.initializeApp(firebaseConfig);
    console.log('Firebaseåˆå§‹åŒ–æˆåŠŸ');
} catch (error) {
    console.error('Firebaseåˆå§‹åŒ–å¤±è´¥:', error);
}

const database = firebase.database();

// Firebaseå·¥å…·å‡½æ•°
const FirebaseService = {
    // è·å–æŒ‡å®šè·¯å¾„çš„todos
    async getTodos(path = '/todos') {
        try {
            const snapshot = await database.ref(path).once('value');
            const data = snapshot.val() || {};
            console.log(`ä»è·¯å¾„ ${path} è·å–åˆ° ${Object.keys(data).length} ä¸ªtodos`);
            return data;
        } catch (error) {
            console.error(`è·å–todoså¤±è´¥ (è·¯å¾„: ${path}):`, error);
            return {};
        }
    },

    // æ·»åŠ æˆ–æ›´æ–°todo
    async saveTodo(todoId, todoData, path = '/todos') {
        try {
            await database.ref(`${path}/${todoId}`).set(todoData);
            console.log(`Todoä¿å­˜æˆåŠŸ: ${todoId} (è·¯å¾„: ${path})`);
            return true;
        } catch (error) {
            console.error(`ä¿å­˜todoå¤±è´¥ (è·¯å¾„: ${path}):`, error);
            return false;
        }
    },

    // åˆ é™¤todo
    async deleteTodo(todoId, path = '/todos') {
        try {
            await database.ref(`${path}/${todoId}`).remove();
            console.log(`Todoåˆ é™¤æˆåŠŸ: ${todoId} (è·¯å¾„: ${path})`);
            return true;
        } catch (error) {
            console.error(`åˆ é™¤todoå¤±è´¥ (è·¯å¾„: ${path}):`, error);
            return false;
        }
    },

    // ç›‘å¬todoså˜åŒ–
    onTodosChange(callback, path = '/todos') {
        database.ref(path).on('value', (snapshot) => {
            const data = snapshot.val() || {};
            callback(data);
        });
        console.log(`å¼€å§‹ç›‘å¬todoså˜åŒ– (è·¯å¾„: ${path})`);
    },

    // åœæ­¢ç›‘å¬todoså˜åŒ–
    offTodosChange(path = '/todos') {
        database.ref(path).off('value');
        console.log(`åœæ­¢ç›‘å¬todoså˜åŒ– (è·¯å¾„: ${path})`);
    },

    // è·å–åº”ç”¨é…ç½®æ•°æ®
    async getAppSettings(path = '/appSetting/todoSetting') {
        try {
            const snapshot = await database.ref(path).once('value');
            const settings = snapshot.val();
            
            if (!settings) {
                console.warn('æœªæ‰¾åˆ°åº”ç”¨é…ç½®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
                return this.getDefaultSettings();
            }
            
            console.log('æˆåŠŸè·å–åº”ç”¨é…ç½®:', settings);
            return settings;
        } catch (error) {
            console.error('è·å–åº”ç”¨é…ç½®å¤±è´¥:', error);
            console.warn('ä½¿ç”¨é»˜è®¤é…ç½®ç»§ç»­è¿è¡Œ');
            return this.getDefaultSettings();
        }
    },

    // ç›‘å¬åº”ç”¨é…ç½®å˜åŒ–
    onAppSettingsChange(callback, path = '/appSetting/todoSetting') {
        database.ref(path).on('value', (snapshot) => {
            const settings = snapshot.val();
            const finalSettings = settings || this.getDefaultSettings();
            callback(finalSettings);
        });
        console.log(`å¼€å§‹ç›‘å¬åº”ç”¨é…ç½®å˜åŒ– (è·¯å¾„: ${path})`);
    },

    // åœæ­¢ç›‘å¬åº”ç”¨é…ç½®å˜åŒ–
    offAppSettingsChange(path = '/appSetting/todoSetting') {
        database.ref(path).off('value');
        console.log(`åœæ­¢ç›‘å¬åº”ç”¨é…ç½®å˜åŒ– (è·¯å¾„: ${path})`);
    },

    // ä¿å­˜åº”ç”¨é…ç½®
    async saveAppSettings(settings, path = '/appSetting/todoSetting') {
        try {
            await database.ref(path).set(settings);
            console.log('åº”ç”¨é…ç½®ä¿å­˜æˆåŠŸ:', settings);
            return true;
        } catch (error) {
            console.error('ä¿å­˜åº”ç”¨é…ç½®å¤±è´¥:', error);
            return false;
        }
    },

    // é»˜è®¤é…ç½®
    getDefaultSettings() {
        return {
            appRootPath: '/todos',
            features: {
                search: true,
                filtering: true,
                archiving: true,
                dueDateWarning: true
            },
            ui: {
                theme: 'light',
                cardsPerRow: 3,
                showAssignee: true,
                showTags: true
            },
            notifications: {
                enabled: true,
                remindBeforeDays: 1
            }
        };
    },

    // æµ‹è¯•æ•°æ®åº“è¿æ¥
    async testConnection() {
        try {
            await database.ref('.info/connected').once('value');
            console.log('Firebaseæ•°æ®åº“è¿æ¥æ­£å¸¸');
            return true;
        } catch (error) {
            console.error('Firebaseæ•°æ®åº“è¿æ¥å¤±è´¥:', error);
            return false;
        }
    }
};
</script>
<script>
        // Todoå·¥å…·å‡½æ•°
class TodoManager {
    constructor() {
        this.todos = {};
        this.currentFilter = '';
        this.currentSearch = '';
    }

    // ç”Ÿæˆå”¯ä¸€ID (YYYYMMDD-UUIDæ ¼å¼)
    generateTodoId() {
        const now = new Date();
        const dateStr = now.toISOString().slice(0,10).replace(/-/g, '');
        const uuid = 'xxxx-xxxx-4xxx-yxxx-xxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
        return `${dateStr}-${uuid}`;
    }

    // åˆ›å»ºæ–°çš„todoå¯¹è±¡
    createTodo(data){
        const now = new Date().toISOString();
        return {
            id: data.id || this.generateTodoId(),
            title: data.title || '',
            tags: Array.isArray(data.tags) ? data.tags : (data.tags || '').split(',').map(tag => tag.trim()).filter(tag => tag),
            startDate: data.startDate || now.split('T')[0],
            endDate: data.endDate || data.startDate || now.split('T')[0],
            priority: data.priority || 'medium',
            assignee: data.assignee || '',
            completed: data.completed || false,
            status: data.status || 'active',
            createdAt: data.createdAt || now,
            updatedAt: now
        };
    }

    // æ¸²æŸ“å•ä¸ªtodoå¡ç‰‡
    renderTodoCardV0(todo) {
        const priorityColors = {
            low: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
            medium: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
            high: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
        }; 

        const statusColors = {
            active: 'border-l-blue-500',
            archived: 'border-l-gray-400',
            deleted: 'border-l-red-300'
        };

        const statusIcons = {
            active: 'ğŸ”µ',
            archived: 'âšª',
            deleted: 'ğŸ”´'
        };

        const isOverdue = new Date(todo.endDate) < new Date() && !todo.completed && todo.status === 'active';
        const isToday = todo.endDate === new Date().toISOString().split('T')[0] && !todo.completed;
        
        return `
            <div class="bg-white dark:bg-gray-700 rounded-lg shadow-md p-4 border-l-4 ${
                statusColors[todo.status] || 'border-l-blue-500'
            } ${todo.status !== 'active' ? 'opacity-75' : ''} fade-in hover:shadow-lg transition-shadow">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        <h3 class="font-semibold text-lg ${
                            todo.completed ? 'line-through text-gray-500 dark:text-gray-400' : 'text-gray-800 dark:text-white'
                        }">
                            ${statusIcons[todo.status] || ''} ${this.escapeHtml(todo.title)}
                        </h3>
                        ${isOverdue ? `
                            <p class="text-xs text-red-500 dark:text-red-400 mt-1">âš ï¸ å·²è¿‡æœŸ</p>
                        ` : isToday ? `
                            <p class="text-xs text-orange-500 dark:text-orange-400 mt-1">ğŸ“… ä»Šå¤©åˆ°æœŸ</p>
                        ` : ''}
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${priorityColors[todo.priority]}">
                            ${this.getPriorityText(todo.priority)}
                        </span>
                        <span class="px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600 dark:bg-gray-600 dark:text-gray-300">
                            ${this.getStatusText(todo.status)}
                        </span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">
                        <span class="font-medium">è´Ÿè´£äºº:</span> ${this.escapeHtml(todo.assignee)}
                    </p>
                    <p class="text-sm text-gray-600 dark:text-gray-300">
                        <span class="font-medium">æ—¥æœŸ:</span> ${todo.startDate} ${todo.startDate !== todo.endDate ? `- ${todo.endDate}` : ''}
                    </p>
                </div>
                
                ${todo.tags && todo.tags.length > 0 ? `
                    <div class="mb-3 flex flex-wrap gap-1">
                        ${todo.tags.map(tag => `
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 text-xs rounded-full">
                                ${this.escapeHtml(tag)}
                            </span>
                        `).join('')}
                    </div>
                ` : ''}
                
                <div class="flex justify-between items-center pt-2 border-t border-gray-200 dark:border-gray-600">
                    <div class="flex gap-2">
                        ${todo.status === 'active' ? `
                            <button onclick="app.editTodo('${todo.id}')" 
                                    class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded transition-colors">
                                ç¼–è¾‘
                            </button>
                            <button onclick="app.archiveTodo('${todo.id}')" 
                                    class="px-3 py-1 bg-yellow-500 hover:bg-yellow-600 text-white text-sm rounded transition-colors">
                                å½’æ¡£
                            </button>
                        ` : ''}
                        
                        ${todo.status === 'archived' ? `
                            <button onclick="app.restoreTodo('${todo.id}')" 
                                    class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white text-sm rounded transition-colors">
                                æ¢å¤
                            </button>
                        ` : ''}
                        
                        <button onclick="app.softDeleteTodo('${todo.id}')" 
                                class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-sm rounded transition-colors">
                            ${todo.status === 'deleted' ? 'å½»åº•åˆ é™¤' : 'åˆ é™¤'}
                        </button>
                    </div>
                    
                    ${todo.status === 'active' ? `
                        <button onclick="app.toggleComplete('${todo.id}')" 
                                class="px-3 py-1 ${
                                    todo.completed ? 'bg-gray-500 hover:bg-gray-600' : 'bg-green-500 hover:bg-green-600'
                                } text-white text-sm rounded transition-colors">
                            ${todo.completed ? 'æœªå®Œæˆ' : 'å®Œæˆ'}
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    }

    renderTodoCard(todo) {
        
        const statusIcons = {
            active: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 32 32"><g fill="none"><path fill="url(#f2964id0)" d="M29.757 15.875c0 7.732-6.268 14-14 14s-14-6.268-14-14s6.268-14 14-14s14 6.268 14 14Z"/><path fill="url(#f2964id4)" d="M29.757 15.875c0 7.732-6.268 14-14 14s-14-6.268-14-14s6.268-14 14-14s14 6.268 14 14Z"/><path fill="url(#f2964id1)" d="M29.757 15.875c0 7.732-6.268 14-14 14s-14-6.268-14-14s6.268-14 14-14s14 6.268 14 14Z"/><path fill="url(#f2964id2)" d="M29.757 15.875c0 7.732-6.268 14-14 14s-14-6.268-14-14s6.268-14 14-14s14 6.268 14 14Z"/><path fill="url(#f2964id3)" d="M29.757 15.875c0 7.732-6.268 14-14 14s-14-6.268-14-14s6.268-14 14-14s14 6.268 14 14Z"/><defs><radialGradient id="f2964id0" cx="0" cy="0" r="1" gradientTransform="rotate(130.168 9.965 9.872) scale(27.8086)" gradientUnits="userSpaceOnUse"><stop offset=".232" stop-color="#F3BB4B"/><stop offset=".959" stop-color="#C79738"/></radialGradient><radialGradient id="f2964id1" cx="0" cy="0" r="1" gradientTransform="rotate(136.38 10.092 10.202) scale(14.6767 15.816)" gradientUnits="userSpaceOnUse"><stop offset=".179" stop-color="#FFE764"/><stop offset="1" stop-color="#F8CA4D" stop-opacity="0"/></radialGradient><radialGradient id="f2964id2" cx="0" cy="0" r="1" gradientTransform="matrix(-19.25 0 0 -20 20.249 15.875)" gradientUnits="userSpaceOnUse"><stop offset=".62" stop-color="#C69B40" stop-opacity="0"/><stop offset=".951" stop-color="#E8C290"/></radialGradient><radialGradient id="f2964id3" cx="0" cy="0" r="1" gradientTransform="matrix(0 21 -23.3208 0 15.757 8.875)" gradientUnits="userSpaceOnUse"><stop offset=".792" stop-color="#E5A152" stop-opacity="0"/><stop offset="1" stop-color="#D17887"/></radialGradient><linearGradient id="f2964id4" x1="15.757" x2="15.757" y1="1.875" y2="8.375" gradientUnits="userSpaceOnUse"><stop stop-color="#E1B45D"/><stop offset="1" stop-color="#E1B45D" stop-opacity="0"/></linearGradient></defs></g></svg>`,
            archived: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" fill="#8a6859"/></svg>`,
            deleted: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"><path fill="#000000" d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2ZM7.19 13.35H5.27l.52-2.41h1.84c1.2 0 1.48.58 1.48 1.05c0 .65-.43 1.36-1.92 1.36Zm.66-3.64H5.94l.52-2.41H8.3c1.19 0 1.47.59 1.47 1c0 .7-.42 1.41-1.92 1.41Zm3.75 7.43H9.68l.53-2.42h1.84c1.19 0 1.47.59 1.47 1.06c0 .65-.42 1.36-1.92 1.36Zm.71-3.79H10.4l.52-2.41h1.84c1.19 0 1.47.58 1.47 1.05c0 .65-.42 1.36-1.92 1.36ZM13 9.71h-1.94l.52-2.41h1.84c1.2 0 1.48.59 1.48 1c0 .7-.43 1.41-1.9 1.41Zm3.74 5.61h-1.93l.52-2.42h1.84c1.19 0 1.48.59 1.48 1.06c0 .65-.43 1.36-1.93 1.36Zm.72-3.44h-1.94L16 9.46h1.84c1.2 0 1.48.59 1.48 1c.04.71-.39 1.42-1.88 1.42Z"/></svg>`
        };

        //low medium high
        const priortyIcons = {
            high: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 48 48"><path fill="#6dd627" d="M25.64 12.68A1.32 1.32 0 0 1 24.22 14c-1.17 0-1.3-1.28-1.3-1.28a15 15 0 0 1 1.36-7.47c2.24-4.76 5.26-5.47 6.79-1.39s-1.05.81-3.4 3.39a9.13 9.13 0 0 0-2.03 5.43Z"/><path fill="#9ceb60" d="M25.48 7.57c1.82-3.83 4.16-5 5.79-3.14l-.2-.57C29.54-.22 26.52.49 24.28 5.21a15 15 0 0 0-1.36 7.47S23 13.86 24.08 14a15.32 15.32 0 0 1 1.4-6.43Z"/><path fill="#45413c" d="M4.32 44.96a19.68 2.04 0 1 0 39.36 0a19.68 2.04 0 1 0-39.36 0Z" opacity=".15"/><path fill="none" stroke="#45413c" stroke-linecap="round" stroke-linejoin="round" d="M25.64 12.68A1.32 1.32 0 0 1 24.22 14c-1.17 0-1.3-1.28-1.3-1.28a15 15 0 0 1 1.36-7.47c2.24-4.76 5.26-5.47 6.79-1.39s-1.05.81-3.4 3.39a9.13 9.13 0 0 0-2.03 5.43Z"/><path fill="#ff6242" d="M36.65 10.58a11.26 11.26 0 0 0-9.82 1.23a5 5 0 0 1-5.66 0a11.26 11.26 0 0 0-9.82-1.23C5.06 12.42 2.17 21.5 4.91 30.85S15 46.29 21.26 44.44a7.48 7.48 0 0 0 1.44-.58a2.73 2.73 0 0 1 2.6 0a7.48 7.48 0 0 0 1.44.58C33 46.29 40.35 40.2 43.09 30.85s-.15-18.43-6.44-20.27Z"/><path fill="#ff866e" d="M11.35 15a12.28 12.28 0 0 1 9.82 1.11a5.48 5.48 0 0 0 5.66 0A12.28 12.28 0 0 1 36.65 15c4.28 1.13 7 5.3 7.41 10.5c.52-7.24-2.34-13.43-7.41-14.91a11.26 11.26 0 0 0-9.82 1.23a5 5 0 0 1-5.66 0a11.26 11.26 0 0 0-9.82-1.23c-5.07 1.48-7.93 7.67-7.41 14.91c.43-5.21 3.13-9.38 7.41-10.5Z"/><path fill="none" stroke="#45413c" stroke-linecap="round" stroke-linejoin="round" d="M36.65 10.58a11.26 11.26 0 0 0-9.82 1.23a5 5 0 0 1-5.66 0a11.26 11.26 0 0 0-9.82-1.23C5.06 12.42 2.17 21.5 4.91 30.85S15 46.29 21.26 44.44a7.48 7.48 0 0 0 1.44-.58a2.73 2.73 0 0 1 2.6 0a7.48 7.48 0 0 0 1.44.58C33 46.29 40.35 40.2 43.09 30.85s-.15-18.43-6.44-20.27Z"/><path fill="#6dd627" d="M22.91 12.56s1.48-5.73-3.39-8.14c-2.74-1.36-6.32-.1-7.63.45a.65.65 0 0 0-.39.77c.38 1.58 1.83 6 6 6.24c5.2.3 5.41.68 5.41.68Z"/><path fill="#9ceb60" d="M12.11 7.48c1.45-.58 4.8-1.65 7.41-.36A6.23 6.23 0 0 1 23 12c.23-1.51.43-5.61-3.5-7.56c-2.74-1.36-6.32-.1-7.63.45a.65.65 0 0 0-.39.77a11.41 11.41 0 0 0 .63 1.82Z"/><path fill="none" stroke="#45413c" stroke-linecap="round" stroke-linejoin="round" d="M22.91 12.56s1.48-5.73-3.39-8.14c-2.74-1.36-6.32-.1-7.63.45a.65.65 0 0 0-.39.77c.38 1.58 1.83 6 6 6.24c5.2.3 5.41.68 5.41.68Z"/><path fill="#6dd627" stroke="#45413c" stroke-linecap="round" stroke-linejoin="round" d="M22.91 12.56a9.84 9.84 0 0 0-4.75-5.43"/></svg>`,
            medium: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" fill="#8a6859"/></svg>`,
            low: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 128 128"><path fill="#6EA517" d="M78.7 52.85L60.22 36.83l6.86-5.1s19.91-11.15 38.9 2.29c18.66 13.2 16.9 52.45 2.46 70.4s-24.47 19.01-29.92 18.83c-5.46-.18-6.34-2.82-11.62-2.29c-5.28.53-7.04 3.52-16.72 2.82c-8.78-.64-16.02-4.05-19.54-7.92c-3.33-3.68 48.06-63.01 48.06-63.01z"/><path fill="#87C244" d="M100.21 34.4s-7.93 3.42-15.85 4.04c-7.93.62-22.07-.47-22.07-.47s-1.55-8.24-2.02-8.24s-21.28-7.24-36.52 4.2C7.69 45.98 6.11 69.38 8.67 80.55c5.89 25.67 24.78 37.76 24.78 37.76s16.87 1.87 38.01-7.45s39.44-25.64 39.01-47.55C110 39.99 100.21 34.4 100.21 34.4z"/><path fill="#E5DD9F" d="M37.7 38.9c-2.71-3.13-10.15-2.43-15.93 5.84c-6.02 8.6-6.29 24.36-1.33 24.79c4.07.35 5.11-6.54 7.61-11.42c4.7-9.16 15.85-12.04 9.65-19.21z"/><path fill="#59702C" d="M44.25 35.36c-1.19 2.48 2.73 8.58 17.37 9.03c15.4.47 20.45-8.11 18.69-10.11c-1.76-2-7.52 1.29-18.45 1.18s-15.58-4.31-17.61-.1z"/><path fill="#513532" d="M51.86 18.64c-1.18-.24-5.99-1.06-6.47-2.94c-.22-.89.94-3.76 4-5.88s6.11-2.7 6.82-1.06c.71 1.65.47 2.7.47 3.06c0 .35 2.42 3.18 4.11 6.82c2.35 5.05 3.64 9.99 3.41 15.05c-.17 3.66-.24 8.82-2.35 8.46c-2.2-.37-1.74-5.53-2.82-9.17c-2.58-8.69-6.46-14.19-7.17-14.34z"/><path fill="#2F7C31" d="M82.59 24.36c.24-.35 24.57-15.63 24.68-16.57S94.7 4.61 86.71 7.55s-16.27 7.67-20.22 15.87c-3.17 6.58-3.17 11.05-2.35 12.11c.39.5 18.45-11.17 18.45-11.17z"/><path fill="#4C8C19" d="M79.89 23.42c10.74-6.86 27.39-15.63 27.39-15.63s.5 1.31-2.7 6.82c-4.23 7.29-14.11 16.69-24.1 19.63c-10.84 3.19-16.34 1.29-16.34 1.29s7.29-6.7 15.75-12.11z"/></svg>`
        };

        let priortyIcon = priortyIcons[todo.priority] ;

        
        let htmlTODO=`
            <div class="outpostCard bg-white dark:bg-zinc-800 shadow-lg rounded-xl overflow-hidden flex p-4">
               <div class="grid grid-cols-[auto_1fr_auto] items-start w-full gap-6">
                  <div class="flex items-start">
                     <img alt="Assignee Avatar" class="w-12 h-12 rounded-full" src="https://lh3.googleusercontent.com/aida-public/AB6AXuC804gkKXN3ZKxUoSXplIbeKq8WNYK2clirp3t0OrKVlp-DDSGlm3abkkk2tn1EsKTJOdBlcxlrYHxAgbjQgs5Ity0OR8XImFwyj_u_BGzWSCBrWnN8EfXNRnLDurup9XGMc3Tea0kBlQKLTYxpuvGWMzEQNmZYuSB83PmIWBVsMWUu6GRAVPcJ4uxqHBIPnr15pxCWQ6RYJH0Z7PSvRwqAoc-27oHbHsFZnm1hVy6fTJo_lhaevkOsClCnt8T61jQHpACt8XET3g4"/>
                  </div>
                  <div class="flex flex-col items-start gap-4">
                     <p class="text-gray-900 dark:text-white font-medium" style="font-size: 2em; line-height: 1.2" >
                        ${todo.title}
                     </p>
                     <div class="flex items-center gap-6 text-gray-500 dark:text-gray-400 text-sm" >
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 36 36"><path fill="#E0E7EC" d="M36 32a4 4 0 0 1-4 4H4a4 4 0 0 1-4-4V9a4 4 0 0 1 4-4h28a4 4 0 0 1 4 4v23z"/><path fill="#66757F" d="M23.657 19.12H17.87c-1.22 0-1.673-.791-1.673-1.56c0-.791.429-1.56 1.673-1.56h8.184c1.154 0 1.628 1.04 1.628 1.628c0 .452-.249.927-.52 1.492l-5.607 11.395c-.633 1.266-.882 1.717-1.899 1.717c-1.244 0-1.877-.949-1.877-1.605c0-.271.068-.474.226-.791l5.652-10.716zM10.889 19h-.5c-1.085 0-1.538-.731-1.538-1.5c0-.792.565-1.5 1.538-1.5h2.015c.972 0 1.515.701 1.515 1.605V30.47c0 1.13-.558 1.763-1.53 1.763s-1.5-.633-1.5-1.763V19z"/><path fill="#DD2F45" d="M34 0h-3.277c.172.295.277.634.277 1a2 2 0 0 1-4 0c0-.366.105-.705.277-1H8.723C8.895.295 9 .634 9 1a2 2 0 0 1-4 0c0-.366.105-.705.277-1H2a2 2 0 0 0-2 2v11h36V2a2 2 0 0 0-2-2z"/><path fill="#F5F8FA" d="M13.182 4.604c0-.5.32-.78.75-.78c.429 0 .749.28.749.78v5.017h1.779c.51 0 .73.38.72.72a.7.7 0 0 1-.72.659h-2.498c-.49 0-.78-.319-.78-.819V4.604zm-6.91 0c0-.5.32-.78.75-.78s.75.28.75.78v3.488c0 .92.589 1.649 1.539 1.649c.909 0 1.529-.769 1.529-1.649V4.604c0-.5.319-.78.749-.78s.75.28.75.78v3.568c0 1.679-1.38 2.949-3.028 2.949c-1.669 0-3.039-1.25-3.039-2.949V4.604zM5.49 9.001c0 1.679-1.069 2.119-1.979 2.119c-.689 0-1.839-.27-1.839-1.14c0-.269.23-.609.56-.609c.4 0 .75.37 1.199.37c.56 0 .56-.52.56-.84V4.604c0-.5.32-.78.749-.78c.431 0 .75.28.75.78v4.397z"/><path fill="#F4ABBA" d="M32 10a1 1 0 1 0 2 0a1 1 0 0 0-2 0m0-3a1 1 0 1 0 2 0a1 1 0 0 0-2 0m-3 3a1 1 0 1 0 2 0a1 1 0 0 0-2 0m0-3a1 1 0 1 0 2 0a1 1 0 0 0-2 0m-3 3a1 1 0 1 0 2 0a1 1 0 0 0-2 0m0-3a1 1 0 1 0 2 0a1 1 0 0 0-2 0m-3 0a1 1 0 1 0 2 0a1 1 0 0 0-2 0m0 3a1 1 0 1 0 2 0a1 1 0 0 0-2 0"/></svg>                           
                            ${todo.startDate} ${todo.startDate !== todo.endDate ? `- ${todo.endDate}` : ''}
                        </div>
                        <div class="flex items-center gap-2">
                           ${priortyIcon}
                        </div>
                        <div class="flex items-center gap-2">
                            ${todo.tags && todo.tags.length > 0 ? `
                                <div class="flex flex-wrap gap-1 items-center">
                                    ${todo.tags.map(tag => `
                                        <!---
                                        <span class="px-2 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 text-xs rounded-full" style="width:4em;">
                                            ${this.escapeHtml(tag)}
                                        </span>
                                        -->
                                        <span class="inline-block w-[5em] truncate" title="${this.escapeHtml(tag)}">
                                            ${this.escapeHtml(tag)}
                                        </span>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                     </div>
                  </div>
                  <div class="flex flex-col items-center gap-1">
                    ${todo.status === 'active' ? `
                            <!----
                            <button onclick="app.editTodo('${todo.id}')" 
                                    class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded transition-colors">
                                ç¼–è¾‘
                            </button>
                            <button onclick="app.archiveTodo('${todo.id}')" 
                                    class="px-3 py-1 bg-yellow-500 hover:bg-yellow-600 text-white text-sm rounded transition-colors">
                                å½’æ¡£
                            </button>
                            --->
                            <button onclick="app.editTodo('${todo.id}')" class="text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-primary transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 32 32"><path fill="#000000" d="M25 4.031c-.766 0-1.516.297-2.094.875L13 14.781l-.219.219l-.062.313l-.688 3.5l-.312 1.468l1.469-.312l3.5-.688l.312-.062l.219-.219l9.875-9.906A2.968 2.968 0 0 0 25 4.03zm0 1.938c.234 0 .465.12.688.343c.445.446.445.93 0 1.375L16 17.376l-1.719.344l.344-1.719l9.688-9.688c.222-.222.453-.343.687-.343zM4 8v20h20V14.812l-2 2V26H6V10h9.188l2-2z"/></svg>
                            </button>
                            <button onclick="app.archiveTodo('${todo.id}')" class="text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-primary transition-colors" >
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m20.25 7.5l-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5m8.25 3v6.75m0 0l-3-3m3 3l3-3M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z"/></svg>                     
                            </button>
                    ` : ''}

                        
                        <button onclick="app.softDeleteTodo('${todo.id}')" class="text-gray-500 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 512 512"><path fill="#000000" d="M96 472a23.82 23.82 0 0 0 23.579 24h272.842A23.82 23.82 0 0 0 416 472V152H96Zm32-288h256v280H128Z"/><path fill="#000000" d="M168 216h32v200h-32zm72 0h32v200h-32zm72 0h32v200h-32zm16-128V40c0-13.458-9.488-24-21.6-24H205.6C193.488 16 184 26.542 184 40v48H64v32h384V88ZM216 48h80v40h-80Z"/></svg>                     
                        </button>
                        <!---
                        <button onclick="app.softDeleteTodo('${todo.id}')" 
                                class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-sm rounded transition-colors">
                            ${todo.status === 'deleted' ? 'å½»åº•åˆ é™¤' : 'åˆ é™¤'}
                        </button>
                        --->
                  </div>
               </div>
            </div>
        ` ;
        return htmlTODO;
    }

    // æ¸²æŸ“æ‰€æœ‰todos
    renderTodos(todos) {
        this.todos = todos;
        const filteredTodos = this.filterTodos(todos);
        const todoList = document.getElementById('todoList');
        const emptyState = document.getElementById('emptyState');
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        this.updateStats(todos, filteredTodos);
        
        if (Object.keys(filteredTodos).length === 0) {
            todoList.classList.add('hidden');
            emptyState.classList.remove('hidden');
        } else {
            todoList.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            todoList.innerHTML = Object.values(filteredTodos)
                .sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt))
                .map(todo => this.renderTodoCard(todo))
                .join('');
        }
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    updateStats(allTodos, filteredTodos) {
        const stats = document.getElementById('stats');
        const total = Object.keys(allTodos).length;
        const active = Object.values(allTodos).filter(todo => todo.status === 'active').length;
        const completed = Object.values(allTodos).filter(todo => todo.completed && todo.status === 'active').length;
        const archived = Object.values(allTodos).filter(todo => todo.status === 'archived').length;
        const displayed = Object.keys(filteredTodos).length;

        stats.innerHTML = `
            <div class="bg-white dark:bg-gray-700 rounded-lg p-4 text-center shadow-sm">
                <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">${total}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">æ€»è®¡</div>
            </div>
            <div class="bg-white dark:bg-gray-700 rounded-lg p-4 text-center shadow-sm">
                <div class="text-2xl font-bold text-green-600 dark:text-green-400">${active}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">æ´»è·ƒ</div>
            </div>
            <div class="bg-white dark:bg-gray-700 rounded-lg p-4 text-center shadow-sm">
                <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">${completed}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">å·²å®Œæˆ</div>
            </div>
            <div class="bg-white dark:bg-gray-700 rounded-lg p-4 text-center shadow-sm">
                <div class="text-2xl font-bold text-gray-600 dark:text-gray-400">${displayed}</div>
                <div class="text-sm text-gray-600 dark:text-gray-400">æ˜¾ç¤ºä¸­</div>
            </div>
        `;
    }

    // è¿‡æ»¤todos
    filterTodos(todos) {
        const statusFilter = document.getElementById('statusFilter').value;
        
        let filtered = { ...todos };
        
        // çŠ¶æ€è¿‡æ»¤
        if (statusFilter && statusFilter !== 'all') {
            filtered = Object.fromEntries(
                Object.entries(filtered).filter(([id, todo]) => 
                    todo.status === statusFilter
                )
            );
        } else if (statusFilter === 'all') {
            // æ˜¾ç¤ºæ‰€æœ‰çŠ¶æ€ï¼ˆé™¤äº†å½»åº•åˆ é™¤çš„ï¼‰
            filtered = Object.fromEntries(
                Object.entries(filtered).filter(([id, todo]) => 
                    todo.status !== 'permanently_deleted'
                )
            );
        } else {
            // é»˜è®¤åªæ˜¾ç¤ºæ´»åŠ¨çŠ¶æ€
            filtered = Object.fromEntries(
                Object.entries(filtered).filter(([id, todo]) => 
                    todo.status === 'active'
                )
            );
        }
        
        // æœç´¢è¿‡æ»¤
        if (this.currentSearch) {
            const searchLower = this.currentSearch.toLowerCase();
            filtered = Object.fromEntries(
                Object.entries(filtered).filter(([id, todo]) => 
                    todo.title.toLowerCase().includes(searchLower) ||
                    todo.assignee.toLowerCase().includes(searchLower) ||
                    (todo.tags && todo.tags.some(tag => tag.toLowerCase().includes(searchLower)))
                )
            );
        }
        
        // æ ‡ç­¾è¿‡æ»¤
        if (this.currentFilter) {
            filtered = Object.fromEntries(
                Object.entries(filtered).filter(([id, todo]) => 
                    todo.tags && todo.tags.includes(this.currentFilter)
                )
            );
        }
        
        return filtered;
    }

    // æ›´æ–°æ ‡ç­¾è¿‡æ»¤å™¨é€‰é¡¹
    updateTagFilter(todos) {
        const tagFilter = document.getElementById('tagFilter');
        const allTags = new Set();
        
        Object.values(todos).forEach(todo => {
            if (todo.tags) {
                todo.tags.forEach(tag => allTags.add(tag));
            }
        });
        
        // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"æ‰€æœ‰æ ‡ç­¾"ï¼‰
        while (tagFilter.children.length > 1) {
            tagFilter.removeChild(tagFilter.lastChild);
        }
        
        // æ·»åŠ æ ‡ç­¾é€‰é¡¹
        Array.from(allTags).sort().forEach(tag => {
            const option = document.createElement('option');
            option.value = tag;
            option.textContent = tag;
            tagFilter.appendChild(option);
        });
    }

    // å·¥å…·å‡½æ•°
    escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    getPriorityText(priority) {
        const texts = { low: 'ä½', medium: 'ä¸­', high: 'é«˜' };
        return texts[priority] || priority;
    }

    getStatusText(status) {
        const statusTexts = {
            active: 'æ´»åŠ¨',
            archived: 'å·²å½’æ¡£',
            deleted: 'å·²åˆ é™¤'
        };
        return statusTexts[status] || status;
    }

    // è·å–todoç»Ÿè®¡ä¿¡æ¯
    getTodoStats(todos) {
        const allTodos = Object.values(todos);
        return {
            total: allTodos.length,
            active: allTodos.filter(todo => todo.status === 'active').length,
            completed: allTodos.filter(todo => todo.completed && todo.status === 'active').length,
            archived: allTodos.filter(todo => todo.status === 'archived').length,
            deleted: allTodos.filter(todo => todo.status === 'deleted').length,
            overdue: allTodos.filter(todo => {
                return new Date(todo.endDate) < new Date() && 
                       !todo.completed && 
                       todo.status === 'active';
            }).length
        };
    }
}
</script>
<script>
// ä¸»åº”ç”¨
const app = {
    todoManager: new TodoManager(),
    appSettings: {},
    currentTodoPath: '/todos',

    async init() {
        console.log('åˆå§‹åŒ–Todoåº”ç”¨...');
        
        // æµ‹è¯•æ•°æ®åº“è¿æ¥
        await FirebaseService.testConnection();
        
        // åŠ è½½åº”ç”¨é…ç½®
        await this.loadAppSettings();
        
        // ç»‘å®šäº‹ä»¶
        this.bindEvents();
        
        // åŠ è½½todos
        await this.loadTodos();
        
        // ç›‘å¬å®æ—¶æ›´æ–°
        this.setupRealtimeListeners();
        
        console.log('Todoåº”ç”¨åˆå§‹åŒ–å®Œæˆ');
    },

    async loadAppSettings(){
        try {
            this.appSettings = await FirebaseService.getAppSettings('/appSetting/todoSetting');
            this.applyAppSettings();
            console.log('åº”ç”¨é…ç½®åŠ è½½å®Œæˆ:', this.appSettings);
        } catch (error) {
            console.error('åŠ è½½åº”ç”¨é…ç½®å¤±è´¥:', error);
            this.appSettings = FirebaseService.getDefaultSettings();
            this.applyAppSettings();
        }
    },

    applyAppSettings(){
        const settings = this.appSettings;
        
        // æ›´æ–°å½“å‰è·¯å¾„
        this.currentTodoPath = settings.appRootPath || '/todos';
        document.getElementById('currentPath').textContent = `è·¯å¾„: ${this.currentTodoPath}`;

        // åŠŸèƒ½å¼€å…³
        if (settings.features) {
            this.toggleFeature('searchInput', settings.features.search);
            this.toggleFeature('tagFilter', settings.features.filtering);
            this.toggleFeature('statusFilter', settings.features.archiving);
        }

        // UIé…ç½®
        if (settings.ui) {
            this.applyUiSettings(settings.ui);
        }
    },

    toggleFeature(elementId, isEnabled) {
        const element = document.getElementById(elementId);
        if (element) {
            element.style.display = isEnabled ? '' : 'none';
        }
    },

    applyUiSettings(uiSettings) {
        // ä¸»é¢˜è®¾ç½®
        if (uiSettings.theme === 'dark' || (uiSettings.theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.body.classList.add('dark');
            document.body.classList.remove('bg-gray-100');
            document.body.classList.add('bg-gray-900');
        } else {
            document.body.classList.remove('dark');
            document.body.classList.remove('bg-gray-900');
            document.body.classList.add('bg-gray-100');
        }

        // æ¯è¡Œå¡ç‰‡æ•°é‡
        if (uiSettings.cardsPerRow) {
            const todoList = document.getElementById('todoList');
            //const gridClass = this.getGridClass(uiSettings.cardsPerRow);
            //todoList.className = `grid gap-4 ${gridClass}`;
        }
    },

    getGridClass(cardsPerRow) {
        const gridClasses = {
            1: 'grid-cols-1',
            2: 'grid-cols-1 md:grid-cols-2',
            3: 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3',
            4: 'grid-cols-1 md:grid-cols-2 lg:grid-cols-4'
        };
        return gridClasses[cardsPerRow] || 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3';
    },

    getTodoRootPath() {
        return this.appSettings.appRootPath || '/todos';
    },

    async loadTodos() {
        try {
            const rootPath = this.getTodoRootPath();
            console.log(`ä»è·¯å¾„åŠ è½½todos: ${rootPath}`);
            
            const todos = await FirebaseService.getTodos(rootPath);
            this.todoManager.renderTodos(todos);
            this.todoManager.updateTagFilter(todos);
        } catch (error) {
            console.error('åŠ è½½todoså¤±è´¥:', error);
            this.showError('åŠ è½½todoså¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        }
    },

    setupRealtimeListeners() {
        const rootPath = this.getTodoRootPath();
        
        // ç›‘å¬todoså˜åŒ–
        FirebaseService.onTodosChange((todos) => {
            console.log('æ£€æµ‹åˆ°todoså˜åŒ–ï¼Œæ›´æ–°ç•Œé¢');
            this.todoManager.renderTodos(todos);
            this.todoManager.updateTagFilter(todos);
        }, rootPath);

        // ç›‘å¬åº”ç”¨é…ç½®å˜åŒ–
        FirebaseService.onAppSettingsChange((settings) => {
            console.log('æ£€æµ‹åˆ°åº”ç”¨é…ç½®å˜åŒ–ï¼Œæ›´æ–°è®¾ç½®');
            this.appSettings = settings;
            this.applyAppSettings();
            
            // é‡æ–°åŠ è½½todosä»¥ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„è·¯å¾„
            this.loadTodos();
        }, '/appSetting/todoSetting');
    },

    bindEvents() {
        // æœç´¢åŠŸèƒ½
        document.getElementById('searchInput').addEventListener('input', (e) => {
            this.todoManager.currentSearch = e.target.value;
            this.todoManager.renderTodos(this.todoManager.todos);
        });

        // æ ‡ç­¾è¿‡æ»¤
        document.getElementById('tagFilter').addEventListener('change', (e) => {
            this.todoManager.currentFilter = e.target.value;
            this.todoManager.renderTodos(this.todoManager.todos);
        });

        // çŠ¶æ€è¿‡æ»¤
        document.getElementById('statusFilter').addEventListener('change', (e) => {
            this.todoManager.renderTodos(this.todoManager.todos);
        });

        // æ–°å»ºTodoæŒ‰é’®
        document.getElementById('addTodoBtn').addEventListener('click', () => {
            this.showDialog();
        });

        // ç©ºçŠ¶æ€æ–°å»ºæŒ‰é’®
        document.getElementById('emptyAddBtn').addEventListener('click', () => {
            this.showDialog();
        });

        // é…ç½®æŒ‰é’®
        document.getElementById('settingsBtn').addEventListener('click', () => {
            this.showSettingsDialog();
        });

        // Todoå¯¹è¯æ¡†äº‹ä»¶
        document.getElementById('cancelBtn').addEventListener('click', () => {
            this.hideDialog();
        });

        document.getElementById('todoForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.saveTodo();
        });

        document.getElementById('todoDialog').addEventListener('click', (e) => {
            if (e.target.id === 'todoDialog') {
                this.hideDialog();
            }
        });

        // é…ç½®å¯¹è¯æ¡†äº‹ä»¶
        document.getElementById('settingsCancelBtn').addEventListener('click', () => {
            this.hideSettingsDialog();
        });

        document.getElementById('saveSettingsBtn').addEventListener('click', () => {
            this.saveAppSettings();
        });

        document.getElementById('resetSettingsBtn').addEventListener('click', () => {
            this.resetAppSettings();
        });

        document.getElementById('settingsDialog').addEventListener('click', (e) => {
            if (e.target.id === 'settingsDialog') {
                this.hideSettingsDialog();
            }
        });

        // æ—¥æœŸé»˜è®¤å€¼
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').value = today;
        document.getElementById('endDate').value = today;

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            if (e.key === 'Escape') {
                this.hideDialog();
                this.hideSettingsDialog();
            }
        });
    },

    showDialog(todo = null) {
        const dialog = document.getElementById('todoDialog');
        const title = document.getElementById('dialogTitle');
        const form = document.getElementById('todoForm');
        
        if (todo) {
            title.textContent = 'ç¼–è¾‘Todo';
            this.populateForm(todo);
        } else {
            title.textContent = 'æ–°å»ºTodo';
            form.reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
        }
        
        dialog.classList.remove('hidden');
        dialog.classList.add('flex');
        document.getElementById('title').focus();
    },

    hideDialog() {
        const dialog = document.getElementById('todoDialog');
        dialog.classList.add('hidden');
        dialog.classList.remove('flex');
    },

    populateForm(todo) {
        document.getElementById('todoId').value = todo.id;
        document.getElementById('title').value = todo.title;
        document.getElementById('tags').value = todo.tags ? todo.tags.join(', ') : '';
        document.getElementById('startDate').value = todo.startDate;
        document.getElementById('endDate').value = todo.endDate;
        document.getElementById('priority').value = todo.priority;
        document.getElementById('assignee').value = todo.assignee;
    },

    async saveTodo() {
        const formData = {
            id: document.getElementById('todoId').value,
            title: document.getElementById('title').value.trim(),
            tags: document.getElementById('tags').value,
            startDate: document.getElementById('startDate').value,
            endDate: document.getElementById('endDate').value,
            priority: document.getElementById('priority').value,
            assignee: document.getElementById('assignee').value.trim()
        };

        // éªŒè¯å¿…å¡«å­—æ®µ
        if (!formData.title || !formData.assignee) {
            this.showError('æ ‡é¢˜å’Œè´Ÿè´£äººä¸ºå¿…å¡«å­—æ®µ');
            return;
        }

        const todo = this.todoManager.createTodo(formData);
        const rootPath = this.getTodoRootPath();
        const success = await FirebaseService.saveTodo(todo.id, todo, rootPath);
        
        if (success) {
            this.hideDialog();
            this.showSuccess('Todoä¿å­˜æˆåŠŸ');
        } else {
            this.showError('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    },

    showSettingsDialog() {
        const dialog = document.getElementById('settingsDialog');
        this.populateSettingsForm();
        dialog.classList.remove('hidden');
        dialog.classList.add('flex');
    },

    hideSettingsDialog() {
        const dialog = document.getElementById('settingsDialog');
        dialog.classList.add('hidden');
        dialog.classList.remove('flex');
    },

    populateSettingsForm() {
        const settings = this.appSettings;
        
        // è·¯å¾„é…ç½®
        document.getElementById('appRootPath').value = settings.appRootPath || '/todos';
        
        // åŠŸèƒ½å¼€å…³
        document.getElementById('featureSearch').checked = settings.features?.search !== false;
        document.getElementById('featureFiltering').checked = settings.features?.filtering !== false;
        document.getElementById('featureArchiving').checked = settings.features?.archiving !== false;
        document.getElementById('featureDueDateWarning').checked = settings.features?.dueDateWarning !== false;
        
        // UIé…ç½®
        document.getElementById('uiTheme').value = settings.ui?.theme || 'light';
        document.getElementById('uiCardsPerRow').value = settings.ui?.cardsPerRow || 3;
    },

    async saveAppSettings() {
        const newSettings = {
            appRootPath: document.getElementById('appRootPath').value.trim() || '/todos',
            features: {
                search: document.getElementById('featureSearch').checked,
                filtering: document.getElementById('featureFiltering').checked,
                archiving: document.getElementById('featureArchiving').checked,
                dueDateWarning: document.getElementById('featureDueDateWarning').checked
            },
            ui: {
                theme: document.getElementById('uiTheme').value,
                cardsPerRow: parseInt(document.getElementById('uiCardsPerRow').value)
            }
        };

        const success = await FirebaseService.saveAppSettings(newSettings);
        if (success) {
            this.appSettings = newSettings;
            this.applyAppSettings();
            this.hideSettingsDialog();
            this.showSuccess('é…ç½®ä¿å­˜æˆåŠŸ');
        } else {
            this.showError('é…ç½®ä¿å­˜å¤±è´¥');
        }
    },

    async resetAppSettings() {
        if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤é…ç½®å—ï¼Ÿ')) {
            const defaultSettings = FirebaseService.getDefaultSettings();
            const success = await FirebaseService.saveAppSettings(defaultSettings);
            if (success) {
                this.appSettings = defaultSettings;
                this.applyAppSettings();
                this.hideSettingsDialog();
                this.showSuccess('å·²é‡ç½®ä¸ºé»˜è®¤é…ç½®');
            } else {
                this.showError('é‡ç½®é…ç½®å¤±è´¥');
            }
        }
    },

    async editTodo(todoId) {
        const todo = this.todoManager.todos[todoId];
        if (todo) {
            this.showDialog(todo);
        }
    },

    async archiveTodo(todoId) {
        if (confirm('ç¡®å®šè¦å½’æ¡£è¿™ä¸ªTodoå—ï¼Ÿå½’æ¡£åå°†ä»æ´»åŠ¨åˆ—è¡¨ä¸­éšè—ã€‚')) {
            await this.updateTodoStatus(todoId, 'archived');
        }
    },

    async restoreTodo(todoId) {
        await this.updateTodoStatus(todoId, 'active');
    },

    async softDeleteTodo(todoId) {
        const todo = this.todoManager.todos[todoId];
        const message = todo?.status === 'deleted' 
            ? 'ç¡®å®šè¦å½»åº•åˆ é™¤è¿™ä¸ªTodoå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚' 
            : 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªTodoå—ï¼Ÿ';
        
        if (confirm(message)) {
            if (todo?.status === 'deleted') {
                // å½»åº•åˆ é™¤
                const rootPath = this.getTodoRootPath();
                const success = await FirebaseService.deleteTodo(todoId, rootPath);
                if (success) {
                    this.showSuccess('Todoå·²å½»åº•åˆ é™¤');
                } else {
                    this.showError('åˆ é™¤å¤±è´¥');
                }
            } else {
                // è½¯åˆ é™¤
                await this.updateTodoStatus(todoId, 'deleted');
            }
        }
    },

    async updateTodoStatus(todoId, newStatus) {
        const todo = this.todoManager.todos[todoId];
        if (todo) {
            const oldStatus = todo.status;
            todo.status = newStatus;
            todo.updatedAt = new Date().toISOString();
            
            const rootPath = this.getTodoRootPath();
            const success = await FirebaseService.saveTodo(todoId, todo, rootPath);
            if (success) {
                const statusMessages = {
                    'active': 'Todoå·²æ¢å¤',
                    'archived': 'Todoå·²å½’æ¡£',
                    'deleted': 'Todoå·²åˆ é™¤'
                };
                this.showSuccess(statusMessages[newStatus] || 'çŠ¶æ€æ›´æ–°æˆåŠŸ');
            } else {
                this.showError('çŠ¶æ€æ›´æ–°å¤±è´¥');
            }
            return success;
        }
        return false;
    },

    async toggleComplete(todoId) {
        const todo = this.todoManager.todos[todoId];
        if (todo) {
            todo.completed = !todo.completed;
            todo.updatedAt = new Date().toISOString();
            
            const rootPath = this.getTodoRootPath();
            const success = await FirebaseService.saveTodo(todoId, todo, rootPath);
            if (success) {
                const message = todo.completed ? 'Todoå·²å®Œæˆ' : 'Todoæ ‡è®°ä¸ºæœªå®Œæˆ';
                this.showSuccess(message);
            } else {
                this.showError('æ“ä½œå¤±è´¥');
            }
        }
    },

    showSuccess(message) {
        this.showNotification(message, 'green');
    },

    showError(message) {
        this.showNotification(message, 'red');
    },

    showNotification(message, color = 'blue') {
        const colors = {
            green: 'bg-green-500',
            red: 'bg-red-500',
            blue: 'bg-blue-500'
        };

        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 ${colors[color]} text-white px-6 py-3 rounded-lg shadow-lg fade-in z-50`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('opacity-0');
            notification.classList.add('transition-opacity');
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }
};

// åˆå§‹åŒ–åº”ç”¨
document.addEventListener('DOMContentLoaded', () => {
    app.init();
});

// å¯¼å‡ºåˆ°å…¨å±€èŒƒå›´
window.app = app;
    </script>
</body>
</html>