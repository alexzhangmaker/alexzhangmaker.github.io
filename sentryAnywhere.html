<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>目录树管理应用</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .tree-node {
            transition: all 0.2s ease;
        }
        .tree-node.dragging {
            opacity: 0.6;
            background-color: #f3f4f6;
        }
        .tree-node.drag-over {
            background-color: #e5e7eb;
        }
        .tree-children {
            margin-left: 1.5rem;
            border-left: 1px dashed #d1d5db;
        }
        .node-content {
            cursor: pointer;
            user-select: none;
        }
        .resize-handle {
            width: 5px;
            background: transparent;
            cursor: col-resize;
            transition: background 0.2s;
        }
        .resize-handle:hover, .resize-handle.active {
            background: #3b82f6;
        }
        .sidebar {
            min-width: 200px;
            max-width: 80%;
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        .node-actions {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .tree-node:hover .node-actions {
            opacity: 1;
        }
        .file-item {
            transition: all 0.2s;
        }
        .file-item:hover {
            background-color: #f3f4f6;
        }
    </style>
    <style>
        .dailyTool{
            display: flex;
            flex-direction: row;
        }

        .dailyTool :hover{
            cursor: pointer;
        }

        .dailyToolAction {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .dailyTool:hover .dailyToolAction {
            opacity: 1;
        }
        
    </style>
    <style>
        .bookmarkItem{
            display: flex;
            flex-direction: row;
            justify-content:flex-start;
            align-items: center;
            gap: 10px;

            width:100% ;
        }
        .bookmarkItem :hover{
            cursor: pointer;
            color: #3b82f6;
        }

        .bookmarkAction {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .bookmarkItem:hover .bookmarkAction {
            opacity: 1;
        }
        
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
    <!-- 顶部工具栏 -->
    <header class="bg-white shadow-sm py-3 px-6 flex items-center justify-between">
        <div class="flex items-center">
            <h1 class="text-xl font-bold text-blue-700">目录树管理应用</h1>
        </div>
        <div class="flex space-x-4">
            <button id="idBTNFreshData" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center">
                <i class="fas fa-sync-alt mr-2"></i>刷新数据
            </button>
            <button id="idBTNSaveChange" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center">
                <i class="fas fa-save mr-2"></i>保存更改
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- 左侧导航栏 -->
        <aside class="sidebar bg-white shadow-md p-4 overflow-y-auto relative" id="sidebar">
            <div class="mb-4">
                <h2 class="text-lg font-semibold text-gray-700">目录导航</h2>
                <div class="relative mt-2">
                    <input type="text" placeholder="搜索目录..." class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                </div>
            </div>
            
            <div class="mt-6">
                <h3 class="text-md font-medium text-gray-600 mb-2 flex items-center justify-between">
                    <span>每日工具</span>
                    <div style="display:flex;flex-direction: row;">
                        <i class="fas fa-info-circle text-blue-400 cursor-pointer mr-2" title="拖拽节点可以重新排序"></i>
                        <i class="fas fa-plus-circle text-green-500 cursor-pointer" id="add-DailyTool-btn" title="添加新节点"></i>
                        <span><svg xmlns="http://www.w3.org/2000/svg" id="idBTNDisplayDailyTools" width="18" height="18" viewBox="0 0 16 16"><path fill="#000000" d="M1 0L0 1l2.2 3.081a1 1 0 0 0 .815.419h.07a1 1 0 0 1 .708.293l2.675 2.675l-2.617 2.654A3.003 3.003 0 0 0 0 13a3 3 0 1 0 5.878-.851l2.654-2.617l.968.968l-.305.914a1 1 0 0 0 .242 1.023l3.27 3.27a.997.997 0 0 0 1.414 0l1.586-1.586a.997.997 0 0 0 0-1.414l-3.27-3.27a1 1 0 0 0-1.023-.242L10.5 9.5l-.96-.96l2.68-2.643A3.005 3.005 0 0 0 16 3c0-.269-.035-.53-.102-.777l-2.14 2.141L12 4l-.364-1.757L13.777.102a3 3 0 0 0-3.675 3.68L7.462 6.46L4.793 3.793a1 1 0 0 1-.293-.707v-.071a1 1 0 0 0-.419-.814L1 0Zm9.646 10.646a.5.5 0 0 1 .708 0l2.914 2.915a.5.5 0 0 1-.707.707l-2.915-2.914a.5.5 0 0 1 0-.708ZM3 11l.471.242l.529.026l.287.445l.445.287l.026.529L5 13l-.242.471l-.026.529l-.445.287l-.287.445l-.529.026L3 15l-.471-.242L2 14.732l-.287-.445L1.268 14l-.026-.529L1 13l.242-.471l.026-.529l.445-.287l.287-.445l.529-.026L3 11Z"/></svg></span>
                    </div>
                </h3>
                <div id="idDailyToolbox" class="mt-2"><!-- 目录树将通过JS动态生成 --></div>
                <h3 class="text-md font-medium text-gray-600 mb-2 flex items-center justify-between">
                    <span>目录结构</span>
                    <div>
                        <i class="fas fa-info-circle text-blue-400 cursor-pointer mr-2" title="拖拽节点可以重新排序"></i>
                        <i class="fas fa-plus-circle text-green-500 cursor-pointer" id="add-node-btn" title="添加新节点"></i>
                        <svg xmlns="http://www.w3.org/2000/svg" id="idBTNDisplayFolders" width="18" height="18" viewBox="0 0 16 16" fill="#000000"><g fill="#000000"><path d="m11.798 8.271l-3.182 1.97c-.27.166-.616-.036-.616-.372V9.1s-2.571-.3-4 2.4c.571-4.8 3.143-4.8 4-4.8v-.769c0-.336.346-.538.616-.371l3.182 1.969c.27.166.27.576 0 .742z"/><path d="m.5 3l.04.87a1.99 1.99 0 0 0-.342 1.311l.637 7A2 2 0 0 0 2.826 14h10.348a2 2 0 0 0 1.991-1.819l.637-7A2 2 0 0 0 13.81 3H9.828a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 6.172 1H2.5a2 2 0 0 0-2 2zm.694 2.09A1 1 0 0 1 2.19 4h11.62a1 1 0 0 1 .996 1.09l-.636 7a1 1 0 0 1-.996.91H2.826a1 1 0 0 1-.995-.91l-.637-7zM6.172 2a1 1 0 0 1 .707.293L7.586 3H2.19c-.24 0-.47.042-.683.12L1.5 2.98a1 1 0 0 1 1-.98h3.672z"/></g></svg>
                    </div>
                </h3>
                <div id="directory-tree" class="mt-2"><!-- 目录树将通过JS动态生成 --></div>
            </div>
            
            <!-- 调整宽度的拖拽手柄 -->
            <div class="resize-handle absolute top-0 right-0 h-full" id="resize-handle"></div>
        </aside>

        <!-- 右侧内容展示区 -->
        <main class="flex-1 bg-gray-50 p-6 overflow-y-auto" id="main-content">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800" id="current-folder">内容展示区域</h2>
                        <span class="ml-2 text-sm text-gray-500" id="items-count"></span>
                    </div>
                    
                    <!-- 文件列表区域 -->
                    <div id="folder-contents">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-blue-50 p-5 rounded-lg">
                                <h3 class="text-lg font-semibold text-blue-700 mb-3">目录树功能</h3>
                                <ul class="list-disc list-inside text-gray-600 space-y-2">
                                    <li>从Firebase获取目录数据</li>
                                    <li>树形结构展示</li>
                                    <li>拖拽排序兄弟节点</li>
                                    <li>展开/折叠子节点</li>
                                    <li>拖拽右侧边界调整导航区宽度</li>
                                    <li>添加新节点功能</li>
                                    <li>删除节点功能</li>
                                    <li>点击文件夹查看内容</li>
                                </ul>
                            </div>
                            
                            <div class="bg-green-50 p-5 rounded-lg">
                                <h3 class="text-lg font-semibold text-green-700 mb-3">操作指南</h3>
                                <ul class="list-disc list-inside text-gray-600 space-y-2">
                                    <li>点击节点可以展开或折叠</li>
                                    <li>拖拽节点到其他位置可以重新排序</li>
                                    <li>使用顶部按钮刷新或保存数据</li>
                                    <li>在搜索框输入内容过滤目录</li>
                                    <li>拖拽左侧导航区右边界调整宽度</li>
                                    <li>点击+图标添加新节点</li>
                                    <li>点击X图标删除节点</li>
                                    <li>点击文件夹查看内容</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 添加节点的模态框 -->
    <div class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden" id="add-node-modal">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">添加新节点</h3>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="node-name">
                    节点名称
                </label>
                <input type="text" id="node-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="flex justify-end space-x-3">
                <button class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded" id="cancel-add">
                    取消
                </button>
                <button class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded" id="confirm-add">
                    确认添加
                </button>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div class="modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden" id="delete-node-modal">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">确认删除</h3>
            <p class="text-gray-600 mb-6" id="delete-confirm-msg">确定要删除这个节点吗？此操作不可撤销。</p>
            <div class="flex justify-end space-x-3">
                <button class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded" id="cancel-delete">
                    取消
                </button>
                <button class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded" id="confirm-delete">
                    确认删除
                </button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="./Lab/DataAPI.js"></script>
    <script src="./js/list.min.js"></script>
    <script>


        // 当前选中的节点
        let selectedNode = null;
        let nodeToDelete = null;

        function renderDailyToolbox(dailyTools,parentElement){
            for(let i=0;i<dailyTools.length;i++){
                let toolNode = document.createElement('div') ;
                toolNode.className = 'dailyTool';
                toolNode.dataset.id = dailyTools[i].id;
                toolNode.dataset.url = dailyTools[i].data.url;
                toolNode.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 6h11M3.8 5.8l.8.8l2-2m-2.8 7.2l.8.8l2-2m-2.8 7.2l.8.8l2-2M9 12h11M9 18h11"/></svg>                    
                    <span class="text-gray-700 flex-grow">${dailyTools[i].title}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="dailyToolAction" viewBox="0 0 24 24"><path fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m20 9l-1.995 11.346A2 2 0 0 1 16.035 22h-8.07a2 2 0 0 1-1.97-1.654L4 9m17-3h-5.625M3 6h5.625m0 0V4a2 2 0 0 1 2-2h2.75a2 2 0 0 1 2 2v2m-6.75 0h6.75"/></svg>
                ` ;
                parentElement.appendChild(toolNode) ;

                toolNode.addEventListener('click',(event)=>{
                    window.open(toolNode.dataset.url,"_blank") ;
                }) ;
            }
        }

        // 目录树渲染功能
        function renderTree(data, parentElement, level = 0) {
            data.forEach(item => {
                const hasChildren = item.children && item.children.length > 0;
                
                const nodeElement = document.createElement('div');
                nodeElement.className = 'tree-node';
                nodeElement.dataset.id = item.id;
                nodeElement.draggable = true;
                
                // 所有节点都显示为文件夹图标
                nodeElement.innerHTML = `
                    <div class="node-content py-2 px-3 rounded-lg flex items-center hover:bg-gray-100 group">
                        <span class="toggle-icon mr-2 text-gray-500 ${hasChildren ? '' : 'invisible'}">
                            <i class="fas fa-caret-right"></i>
                        </span>
                        <i class="fas fa-folder text-yellow-500 mr-2"></i>
                        <span class="text-gray-700 flex-grow">${item.name}</span>
                        <div class="node-actions flex">
                            <i class="fas fa-times text-red-400 hover:text-red-600 ml-2 delete-node" title="删除节点"></i>
                        </div>
                    </div>
                    ${hasChildren ? `<div class="tree-children ${level > 0 ? 'pl-4' : ''}"></div>` : ''}
                `;

                
                parentElement.appendChild(nodeElement);
                
                // 添加展开/折叠功能
                const toggleIcon = nodeElement.querySelector('.toggle-icon');
                const childrenContainer = nodeElement.querySelector('.tree-children');
                
                if (hasChildren && childrenContainer) {
                    let expanded = false;
                    
                    toggleIcon.addEventListener('click', (e) => {
                        e.stopPropagation();
                        expanded = !expanded;
                        
                        if (expanded) {
                            childrenContainer.style.display = 'block';
                            toggleIcon.innerHTML = '<i class="fas fa-caret-down"></i>';
                            renderTree(item.children, childrenContainer, level + 1);
                        } else {
                            childrenContainer.style.display = 'none';
                            toggleIcon.innerHTML = '<i class="fas fa-caret-right"></i>';
                            childrenContainer.innerHTML = '';
                        }
                    });
                }
                
                // 添加点击事件
                const nodeContent = nodeElement.querySelector('.node-content');
                nodeContent.addEventListener('click', () => {
                    document.querySelectorAll('.node-content').forEach(el => {
                        el.classList.remove('bg-blue-100', 'font-semibold');
                    });
                    nodeContent.classList.add('bg-blue-100', 'font-semibold');
                    
                    // 更新当前选中的节点
                    selectedNode = item;
                    
                    // 显示文件夹内容
                    displayFolderContents(item);
                });
                
                // 添加删除节点事件
                const deleteBtn = nodeElement.querySelector('.delete-node');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    nodeToDelete = item;
                    showDeleteModal();
                });
                
                // 添加拖拽事件
                nodeElement.addEventListener('dragstart', handleDragStart);
                nodeElement.addEventListener('dragover', handleDragOver);
                nodeElement.addEventListener('dragenter', handleDragEnter);
                nodeElement.addEventListener('dragleave', handleDragLeave);
                nodeElement.addEventListener('drop', handleDrop);
                nodeElement.addEventListener('dragend', handleDragEnd);
            });
        }

        // 显示文件夹内容
        function displayFoldersInFolder(folder) {
            const folderContents = document.getElementById('folder-contents');
            const currentFolder = document.getElementById('current-folder');
            
            // 更新标题
            currentFolder.textContent = folder.name;
            
            // 清空内容区域
            folderContents.innerHTML = '';
            
            // 检查文件夹是否为空
            if (!folder.children || folder.children.length === 0) {
                folderContents.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-folder-open text-5xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">此文件夹为空</p>
                    </div>
                `;
                document.getElementById('items-count').textContent = '(0 个项目)';
                return;
            }
            
            // 显示项目数量
            const itemsCount = folder.children.length;
            document.getElementById('items-count').textContent = `(${itemsCount} 个项目)`;
            
            // 创建文件列表容器
            const fileList = document.createElement('div');
            fileList.className = 'bg-gray-50 rounded-lg p-4';
            
            // 添加标题
            const title = document.createElement('h3');
            title.className = 'text-lg font-semibold text-gray-700 mb-4';
            title.textContent = '内容';
            fileList.appendChild(title);
            
            // 添加文件和文件夹项目
            folder.children.forEach(item => {
                const isFolder = item.type === 'folder';
                
                const itemElement = document.createElement('div');
                itemElement.className = 'file-item flex items-center py-3 px-4 border-b border-gray-200 last:border-b-0';
                
                itemElement.innerHTML = `
                    <i class="fas ${isFolder ? 'fa-folder text-yellow-500' : 'fa-file text-blue-400'} mr-3"></i>
                    <span class="text-gray-700 flex-grow">${item.name}</span>
                    <span class="text-xs text-gray-500">${isFolder ? '文件夹' : '文件'}</span>
                `;
                
                // 添加点击事件（如果是文件夹）
                if (isFolder) {
                    itemElement.style.cursor = 'pointer';
                    itemElement.addEventListener('click', () => {
                        // 在目录树中找到并高亮对应的节点
                        highlightTreeNode(item.id);
                        // 显示文件夹内容
                        displayFolderContents(item);
                    });
                }
                
                fileList.appendChild(itemElement);
            });
            
            folderContents.appendChild(fileList);
        }

        function displayFolderContents(folder) {
            const folderContents = document.getElementById('folder-contents');
            const currentFolder = document.getElementById('current-folder');

            //let tagBookmarks = document.
            console.log(folder) ;
            // 更新标题
            currentFolder.textContent = folder.name;
            // 清空内容区域
            folderContents.innerHTML = `
                <div id="idBookmarkList"></div>
            `;
            let bookmarksInFolder = fetchFolderBookmarks(folder) ;
            console.log(bookmarksInFolder) ;
            bookmarksInFolder.forEach(bookmark=>{
                renderBookmark(bookmark,folderContents) ;
            }) ;
        }

        function renderBookmark(bookmark,tagContainer){
            let tagBookmark = document.createElement('div') ;
            tagBookmark.classList.add("bookmarkItem")
            tagBookmark.dataset.dataID = bookmark.id ;
            tagContainer.appendChild(tagBookmark) ;
            tagBookmark.innerHTML=`
                <svg xmlns="http://www.w3.org/2000/svg" class="bookmarkAction" width="18" height="18" viewBox="0 0 16 16"><path fill="#000000" d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11Zm1.958 1l-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5h9.916Zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47ZM8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z"/></svg>
                <a href="${bookmark.url}" target="_blank">${bookmark.title}</a>
            ` ;
            tagBookmark.querySelector('.bookmarkAction').addEventListener('click',async (event)=>{
                await removeBookmark(tagBookmark.dataset.dataID) ;
                tagBookmark.remove() ;

            }) ;

        }

        // 高亮目录树中的节点
        function highlightTreeNode(nodeId) {
            // 清除所有高亮
            document.querySelectorAll('.node-content').forEach(el => {
                el.classList.remove('bg-blue-100', 'font-semibold');
            });
            
            // 找到对应节点并高亮
            const nodeElement = document.querySelector(`.tree-node[data-id="${nodeId}"]`);
            if (nodeElement) {
                const nodeContent = nodeElement.querySelector('.node-content');
                nodeContent.classList.add('bg-blue-100', 'font-semibold');
                
                // 确保节点可见（展开父节点）
                let parent = nodeElement.parentElement;
                while (parent && parent.classList.contains('tree-children')) {
                    const parentNode = parent.previousElementSibling;
                    if (parentNode) {
                        const toggleIcon = parentNode.querySelector('.toggle-icon');
                        if (toggleIcon && !toggleIcon.classList.contains('invisible')) {
                            const childrenContainer = parentNode.nextElementSibling;
                            if (childrenContainer.style.display === 'none') {
                                toggleIcon.click();
                            }
                        }
                    }
                    parent = parent.parentElement;
                }
                
                // 滚动到节点位置
                nodeElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // 显示添加节点模态框
        function showAddModal() {
            /*
            if (!selectedNode) {
                alert('请先选择一个节点作为父节点');
                return;
            }
            */
            document.getElementById('add-node-modal').classList.remove('hidden');
            document.getElementById('node-name').value = '';
            document.getElementById('node-name').focus();
        }

        // 隐藏添加节点模态框
        function hideAddModal() {
            document.getElementById('add-node-modal').classList.add('hidden');
        }

        // 显示删除确认模态框
        function showDeleteModal() {
            if (!nodeToDelete) return;
            
            const hasChildren = nodeToDelete.children && nodeToDelete.children.length > 0;
            
            if (hasChildren) {
                document.getElementById('delete-confirm-msg').textContent = 
                    '该节点包含子节点，无法删除。请先删除所有子节点。';
                document.getElementById('confirm-delete').disabled = true;
                document.getElementById('confirm-delete').classList.add('opacity-50');
            } else {
                document.getElementById('delete-confirm-msg').textContent = 
                    '确定要删除这个节点吗？此操作不可撤销。';
                document.getElementById('confirm-delete').disabled = false;
                document.getElementById('confirm-delete').classList.remove('opacity-50');
            }
            
            document.getElementById('delete-node-modal').classList.remove('hidden');
        }

        // 隐藏删除确认模态框
        function hideDeleteModal() {
            document.getElementById('delete-node-modal').classList.add('hidden');
            nodeToDelete = null;
        }

        // 添加新节点
        function addNewNode() {
            const nodeName = document.getElementById('node-name').value.trim();
            if (!nodeName) {
                alert('请输入节点名称');
                return;
            }
            
            let jsonFolder={
                id:crypto.randomUUID(),
                name:nodeName,
                type:'folder',
                children: []
            } ;
            if (!selectedNode) {
                plusFolderatRoot(jsonFolder);
            }else{
                // 生成唯一ID
                plusFolder2Folder(jsonFolder,selectedNode) ;
            }
            
            // 重新渲染目录树
            const treeContainer = document.getElementById('directory-tree');
            treeContainer.innerHTML = '';
            renderTree(gFolderTree, treeContainer);
            
            // 隐藏模态框
            hideAddModal();
            
            // 更新内容显示
            displayFolderContents(selectedNode);
        }

        // 删除节点
        function deleteNode() {
            if (!nodeToDelete) return;
            
            // 检查是否有子节点
            const hasChildren = nodeToDelete.children && nodeToDelete.children.length > 0;
            if (hasChildren) {
                alert('无法删除包含子节点的节点');
                hideDeleteModal();
                return;
            }
            removeFolderFromForest(nodeToDelete.id);
            
            // 重新渲染目录树
            const treeContainer = document.getElementById('directory-tree');
            treeContainer.innerHTML = '';
            renderTree(gFolderTree, treeContainer);
            
            // 隐藏模态框
            hideDeleteModal();
            
            // 清除当前选中节点
            selectedNode = null;
            
            // 重置内容显示
            document.getElementById('current-folder').textContent = '内容展示区域';
            document.getElementById('items-count').textContent = '';
            document.getElementById('folder-contents').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-blue-50 p-5 rounded-lg">
                        <h3 class="text-lg font-semibold text-blue-700 mb-3">目录树功能</h3>
                        <ul class="list-disc list-inside text-gray-600 space-y-2">
                            <li>从Firebase获取目录数据</li>
                            <li>树形结构展示</li>
                            <li>拖拽排序兄弟节点</li>
                            <li>展开/折叠子节点</li>
                            <li>拖拽右侧边界调整导航区宽度</li>
                            <li>添加新节点功能</li>
                            <li>删除节点功能</li>
                            <li>点击文件夹查看内容</li>
                        </ul>
                    </div>
                    
                    <div class="bg-green-50 p-5 rounded-lg">
                        <h3 class="text-lg font-semibold text-green-700 mb-3">操作指南</h3>
                        <ul class="list-disc list-inside text-gray-600 space-y-2">
                            <li>点击节点可以展开或折叠</li>
                            <li>拖拽节点到其他位置可以重新排序</li>
                            <li>使用顶部按钮刷新或保存数据</li>
                            <li>在搜索框输入内容过滤目录</li>
                            <li>拖拽左侧导航区右边界调整宽度</li>
                            <li>点击+图标添加新节点</li>
                            <li>点击X图标删除节点</li>
                            <li>点击文件夹查看内容</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // 拖拽相关变量
        let draggedItem = null;

        // 拖拽事件处理函数
        function handleDragStart(e) {
            draggedItem = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.id);
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (draggedItem !== this) {
                // 检查是否是兄弟节点（简单实现，实际应用中需要更复杂的验证）
                const parent = this.parentElement;
                if (parent === draggedItem.parentElement) {
                    // 获取所有兄弟节点
                    const siblings = Array.from(parent.children);
                    const thisIndex = siblings.indexOf(this);
                    const draggedIndex = siblings.indexOf(draggedItem);
                    
                    if (draggedIndex < thisIndex) {
                        parent.insertBefore(draggedItem, this.nextSibling);
                    } else {
                        parent.insertBefore(draggedItem, this);
                    }
                }
            }
            
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.tree-node').forEach(node => {
                node.classList.remove('drag-over');
            });
        }

        // 调整侧边栏宽度功能
        function initResizeHandler() {
            const resizeHandle = document.getElementById('resize-handle');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            
            let isResizing = false;
            
            resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                resizeHandle.classList.add('active');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const containerRect = sidebar.parentElement.getBoundingClientRect();
                const widthPercentage = ((e.clientX - containerRect.left) / containerRect.width) * 100;
                
                // 设置最小和最大宽度限制
                const newWidth = Math.max(20, Math.min(80, widthPercentage));
                
                sidebar.style.width = `${newWidth}%`;
                mainContent.style.width = `${100 - newWidth}%`;
            });
            
            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    resizeHandle.classList.remove('active');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', async () => {
            const treeContainer = document.getElementById('directory-tree');
            //loadAppData() ;
            await asyncLoadAppData() ;
            console.log("====>>>=======") ;
            console.log(gFolderTree);
            // 渲染目录树
            renderDailyToolbox(gDialyTools,document.getElementById('idDailyToolbox')) ;
            renderTree(gFolderTree, treeContainer);
            
            // 初始化调整宽度功能
            initResizeHandler();
            
            
            
            // 添加搜索功能
            const searchInput = document.querySelector('input[type="text"]');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                
                document.querySelectorAll('.node-content').forEach(node => {
                    const nodeText = node.textContent.toLowerCase();
                    const treeNode = node.closest('.tree-node');
                    
                    if (nodeText.includes(searchTerm)) {
                        treeNode.style.display = 'block';
                        // 展开父节点
                        let parent = treeNode.parentElement;
                        while (parent && parent.classList.contains('tree-children')) {
                            const parentNode = parent.previousElementSibling;
                            if (parentNode) {
                                const toggleIcon = parentNode.querySelector('.toggle-icon');
                                if (toggleIcon && !toggleIcon.classList.contains('invisible')) {
                                    const childrenContainer = parentNode.nextElementSibling;
                                    if (childrenContainer.style.display === 'none') {
                                        toggleIcon.click();
                                    }
                                }
                            }
                            parent = parent.parentElement;
                        }
                    } else {
                        treeNode.style.display = 'none';
                    }
                });
            });
            
            // 添加节点按钮事件
            document.getElementById('add-node-btn').addEventListener('click', showAddModal);
            
            // 模态框按钮事件
            document.getElementById('cancel-add').addEventListener('click', hideAddModal);
            document.getElementById('confirm-add').addEventListener('click', addNewNode);
            document.getElementById('cancel-delete').addEventListener('click', hideDeleteModal);
            document.getElementById('confirm-delete').addEventListener('click', deleteNode);
            
            // 按ESC键关闭模态框
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideAddModal();
                    hideDeleteModal();
                }
            });
        });
    </script>
    <script>
        const btnSaveChange = document.getElementById('idBTNSaveChange') ;
        btnSaveChange.addEventListener('click',async (event)=>{
            await asyncSaveAppData() ;
        }) ;

        // 添加刷新按钮事件
        document.querySelector('#idBTNFreshData').addEventListener('click', () => {
                const treeContainer = document.getElementById('directory-tree');
                treeContainer.innerHTML = '';
                renderTree(gFolderTree, treeContainer);
                
                // 重置内容显示
                document.getElementById('current-folder').textContent = '内容展示区域';
                document.getElementById('items-count').textContent = '';
                document.getElementById('folder-contents').innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-blue-50 p-5 rounded-lg">
                            <h3 class="text-lg font-semibold text-blue-700 mb-3">目录树功能</h3>
                            <ul class="list-disc list-inside text-gray-600 space-y-2">
                                <li>从Firebase获取目录数据</li>
                                <li>树形结构展示</li>
                                <li>拖拽排序兄弟节点</li>
                                <li>展开/折叠子节点</li>
                                <li>拖拽右侧边界调整导航区宽度</li>
                                <li>添加新节点功能</li>
                                <li>删除节点功能</li>
                                <li>点击文件夹查看内容</li>
                            </ul>
                        </div>
                        
                        <div class="bg-green-50 p-5 rounded-lg">
                            <h3 class="text-lg font-semibold text-green-700 mb-3">操作指南</h3>
                            <ul class="list-disc list-inside text-gray-600 space-y-2">
                                <li>点击节点可以展开或折叠</li>
                                <li>拖拽节点到其他位置可以重新排序</li>
                                <li>使用顶部按钮刷新或保存数据</li>
                                <li>在搜索框输入内容过滤目录</li>
                                <li>拖拽左侧导航区右边界调整宽度</li>
                                <li>点击+图标添加新节点</li>
                                <li>点击X图标删除节点</li>
                                <li>点击文件夹查看内容</li>
                            </ul>
                        </div>
                    </div>
                `;
            });

            document.querySelector("#idBTNDisplayDailyTools").addEventListener('click',(event)=>{
                const folderContents = document.getElementById('folder-contents');
                const currentFolder = document.getElementById('current-folder');

                //let tagBookmarks = document.
                //console.log(folder) ;
                // 更新标题
                currentFolder.textContent = "daily Toolbox";
                folderContents.innerHTML=`
                    <div class="canvasDailyToolbar">
                        <svg xmlns="http://www.w3.org/2000/svg" class="canvasToolbarBTN" width="18" height="18" viewBox="0 0 16 16" fill="#000000"><g fill="#000000"><path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM2 2a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H2z"/><path d="M2.5 4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H3a.5.5 0 0 1-.5-.5V4zM8 8a.5.5 0 0 1 .5.5V10H10a.5.5 0 0 1 0 1H8.5v1.5a.5.5 0 0 1-1 0V11H6a.5.5 0 0 1 0-1h1.5V8.5A.5.5 0 0 1 8 8z"/></g></svg>
                    </div>

                    <div class="canvasDailyTools"></div>
                `;

                function _renderDailyTool(jsonTool,tagContainer){
                    let tagTool = document.createElement('div') ;
                    tagContainer.appendChild(tagTool) ;
                    tagTool.classList.add("dailyTool");
                    tagTool.dataset.toolID = jsonTool.id ;
                    tagTool.dataset.url = jsonTool.data.url ;
                    tagTool.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="dailyToolAction" viewBox="0 0 24 24"><path fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m20 9l-1.995 11.346A2 2 0 0 1 16.035 22h-8.07a2 2 0 0 1-1.97-1.654L4 9m17-3h-5.625M3 6h5.625m0 0V4a2 2 0 0 1 2-2h2.75a2 2 0 0 1 2 2v2m-6.75 0h6.75"/></svg>
                        <a href="${tagTool.dataset.url}" target="_blank">${jsonTool.title}</a>
                    ` ;
                    tagTool.querySelector('.dailyToolAction').addEventListener('click',(event)=>{
                        tagTool.remove() ;
                    }) ;
                }
                let tagToolsContainer = folderContents.querySelector('.canvasDailyTools') ;
                console.log(gDialyTools) ;
                for(let i=0;i<gDialyTools.length;i++){
                    _renderDailyTool(gDialyTools[i],tagToolsContainer) ;

                }

                function  callbackPlusTool(jsonTool){
                    let tagToolsContainer = folderContents.querySelector('.canvasDailyTools') ;
                    plusDailyTool(jsonTool) ;
                    _renderDailyTool(jsonTool,tagToolsContainer) ;
                }

                folderContents.querySelector(".canvasToolbarBTN").addEventListener('click',(event)=>{
                    alert('dsfdfs')
                    let jsonTool = {
                        id:'dsdfsdf',
                        type:"Gateway.Bookmark",
                        title:'demo',
                        data:{
                            url:'https://gemini.google.com/app/b350b4901b28dfe1?pli=1'
                        }
                    } ;
                    callbackPlusTool(jsonTool) ;
                }) ;
            }) ;
    </script>
</body>
</html>